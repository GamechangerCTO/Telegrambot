/**
 * üéØ BETTING TIPS GENERATOR
 * 
 * Flow for Betting Tips Content:
 * 1. Get best matches ‚Üí 2. Analyze team statistics ‚Üí 3. Generate predictions ‚Üí 4. Calculate confidence ‚Üí 5. AI edit ‚Üí 6. Add disclaimers
 * 
 * Key features:
 * - Actual betting predictions with statistical backing
 * - Educational approach with reasoning
 * - Confidence scoring system
 * - Responsible gambling disclaimers
 * - Multi-language support
 */

import { unifiedFootballService } from './unified-football-service';
import { aiImageGenerator } from './ai-image-generator';
import { supabase } from '@/lib/supabase';
import { getOpenAIClient } from '../api-keys';

export interface BettingPrediction {
  type: 'match_result' | 'both_teams_score' | 'over_under' | 'first_half' | 'corners' | 'cards';
  prediction: string;
  confidence: number;
  reasoning: string;
  odds_estimate?: string;
  risk_level: 'LOW' | 'MEDIUM' | 'HIGH';
}

export interface BettingAnalysis {
  homeTeam: string;
  awayTeam: string;
  competition: string;
  kickoff: string;
  
  // Statistical foundation
  teamStats: {
    home: {
      form: string;
      winRate: number;
      goalsFor: number;
      goalsAgainst: number;
      homeAdvantage: number;
    };
    away: {
      form: string;
      winRate: number;
      goalsFor: number;
      goalsAgainst: number;
      awayForm: number;
    };
  };
  
  // Head to head
  headToHead: {
    totalMeetings: number;
    homeWins: number;
    awayWins: number;
    draws: number;
    avgGoals: number;
    recentTrend: string;
  };
  
  // Predictions
  predictions: BettingPrediction[];
  
  // Overall assessment
  matchAssessment: {
    predictability: 'HIGH' | 'MEDIUM' | 'LOW';
    overallConfidence: number;
    riskWarning?: string;
  };
}

export interface BettingTipRequest {
  language: 'en' | 'am' | 'sw';
  channelId: string;
  maxPredictions?: number;
  riskTolerance?: 'conservative' | 'moderate' | 'aggressive';
}

export interface GeneratedBettingTip {
  title: string;
  content: string;
  imageUrl?: string;
  analysis: BettingAnalysis;
  aiEditedContent?: string;
  disclaimers: string[];
  metadata: {
    language: string;
    generatedAt: string;
    contentId: string;
    confidenceLevel: number;
    riskLevel: string;
  };
}

export class BettingTipsGenerator {

  /**
   * üéØ MAIN FUNCTION - Generate betting tips content
   */
  async generateBettingTips(request: BettingTipRequest): Promise<GeneratedBettingTip | null> {
    console.log(`üéØ Generating betting tips in ${request.language}`);
    
    try {
      // Step 1: Get best match for betting analysis
      const bestMatch = await this.getBestMatchForBetting(request.language);
      if (!bestMatch) {
        console.log(`‚ùå No suitable match found for betting tips`);
        return null;
      }

      console.log(`‚úÖ Selected match: ${bestMatch.homeTeam.name} vs ${bestMatch.awayTeam.name}`);

      // Step 2: Perform comprehensive betting analysis
      const analysis = await this.performBettingAnalysis(bestMatch);
      
      // Step 3: Check if analysis meets confidence threshold
      if (analysis.matchAssessment.overallConfidence < 60) {
        console.log(`‚ö†Ô∏è Match confidence too low: ${analysis.matchAssessment.overallConfidence}%`);
        return null;
      }

      // Step 4: Generate and upload image
      const imageUrl = await this.generateBettingImage(analysis);
      
      // Step 5: Generate text content with AI editing
      const { content, aiEditedContent } = await this.generateBettingContent(analysis, request.language);
      
      // Step 6: Add responsible gambling disclaimers
      const disclaimers = this.getDisclaimers(request.language);
      
      // Step 7: Mark content as used for uniqueness
      await this.markContentAsUsed(analysis, request.channelId);

      return {
        title: `üéØ ${analysis.homeTeam} vs ${analysis.awayTeam} - Betting Analysis`,
        content,
        imageUrl,
        analysis,
        aiEditedContent,
        disclaimers,
        metadata: {
          language: request.language,
          generatedAt: new Date().toISOString(),
          contentId: `betting_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          confidenceLevel: analysis.matchAssessment.overallConfidence,
          riskLevel: analysis.matchAssessment.predictability
        }
      };

    } catch (error) {
      console.error(`‚ùå Error generating betting tips:`, error);
      return null;
    }
  }

  /**
   * üèÜ Step 1: Get best match for betting analysis
   */
  private async getBestMatchForBetting(language: 'en' | 'am' | 'sw') {
    return await unifiedFootballService.getBestMatchForContent('betting_tip', language);
  }

  /**
   * üìä Step 2: Perform comprehensive betting analysis
   */
  private async performBettingAnalysis(match: any): Promise<BettingAnalysis> {
    console.log(`üìä Performing betting analysis for ${match.homeTeam.name} vs ${match.awayTeam.name}`);

    // Get comprehensive data using IDs if available, otherwise fallback to names
    let homeAnalysis, awayAnalysis, detailedInfo;
    
    if (match.homeTeam.id && match.awayTeam.id) {
      console.log(`‚úÖ Using team IDs: Home ${match.homeTeam.id}, Away ${match.awayTeam.id}`);
      [homeAnalysis, awayAnalysis, detailedInfo] = await Promise.all([
        unifiedFootballService.getTeamAnalysisById(match.homeTeam.id, match.homeTeam.name),
        unifiedFootballService.getTeamAnalysisById(match.awayTeam.id, match.awayTeam.name),
        unifiedFootballService.getDetailedMatchInfoByIds(
          match.homeTeam.id, 
          match.homeTeam.name, 
          match.awayTeam.id, 
          match.awayTeam.name
        )
      ]);
    } else {
      console.log(`‚ö†Ô∏è No team IDs available, falling back to name search`);
      [homeAnalysis, awayAnalysis, detailedInfo] = await Promise.all([
        unifiedFootballService.getTeamAnalysis(match.homeTeam.name),
        unifiedFootballService.getTeamAnalysis(match.awayTeam.name),
        unifiedFootballService.getDetailedMatchInfo(match.homeTeam.name, match.awayTeam.name)
      ]);
    }

    // Calculate team statistics
    const teamStats = this.calculateTeamStats(homeAnalysis, awayAnalysis);
    
    // Analyze head-to-head
    const headToHead = this.analyzeHeadToHead(detailedInfo?.headToHead);
    
    // Generate predictions
    const predictions = this.generatePredictions(teamStats, headToHead, match);
    
    // Calculate overall assessment
    const matchAssessment = this.calculateMatchAssessment(predictions, teamStats);

    return {
      homeTeam: match.homeTeam.name,
      awayTeam: match.awayTeam.name,
      competition: match.competition.name,
      kickoff: match.kickoff || new Date().toISOString(),
      teamStats,
      headToHead,
      predictions,
      matchAssessment
    };
  }

  /**
   * üìà Calculate team statistics for betting analysis
   */
  private calculateTeamStats(homeAnalysis: any, awayAnalysis: any) {
    // Home team stats
    const homeStats = {
      form: homeAnalysis?.statistics?.form || 'Unknown',
      winRate: homeAnalysis?.statistics?.winRate || 0,
      goalsFor: homeAnalysis?.statistics?.goalsFor || 0,
      goalsAgainst: homeAnalysis?.statistics?.goalsAgainst || 0,
      homeAdvantage: this.calculateHomeAdvantage(homeAnalysis)
    };

    // Away team stats  
    const awayStats = {
      form: awayAnalysis?.statistics?.form || 'Unknown',
      winRate: awayAnalysis?.statistics?.winRate || 0,
      goalsFor: awayAnalysis?.statistics?.goalsFor || 0,
      goalsAgainst: awayAnalysis?.statistics?.goalsAgainst || 0,
      awayForm: this.calculateAwayForm(awayAnalysis)
    };

    return { home: homeStats, away: awayStats };
  }

  /**
   * üè† Calculate home advantage factor
   */
  private calculateHomeAdvantage(homeAnalysis: any): number {
    // Home teams typically have 5-15% advantage
    const baseAdvantage = 10;
    
    // Boost based on home form
    const form = homeAnalysis?.statistics?.form || '';
    let formBonus = 0;
    
    // Count recent wins at home (simplified)
    const wins = (form.match(/W/g) || []).length;
    formBonus = wins * 2;
    
    return Math.min(baseAdvantage + formBonus, 25); // Cap at 25%
  }

  /**
   * ‚úàÔ∏è Calculate away form factor
   */
  private calculateAwayForm(awayAnalysis: any): number {
    // Away teams typically perform 5-10% worse
    const baseReduction = -8;
    
    const form = awayAnalysis?.statistics?.form || '';
    let formAdjustment = 0;
    
    // Count recent away performance
    const wins = (form.match(/W/g) || []).length;
    const losses = (form.match(/L/g) || []).length;
    
    formAdjustment = (wins * 3) - (losses * 2);
    
    return Math.max(baseReduction + formAdjustment, -20); // Cap at -20%
  }

  /**
   * üîÑ Analyze head-to-head history
   */
  private analyzeHeadToHead(h2hData: any) {
    if (!h2hData || !h2hData.lastMeetings?.length) {
      return {
        totalMeetings: 0,
        homeWins: 0,
        awayWins: 0,
        draws: 0,
        avgGoals: 2.5,
        recentTrend: 'No recent data'
      };
    }

    const meetings = h2hData.lastMeetings.slice(0, 10); // Last 10 games
    let totalGoals = 0;
    let homeWins = 0;
    let awayWins = 0;
    let draws = 0;

    meetings.forEach((match: any) => {
      const homeScore = match.match_hometeam_score || 0;
      const awayScore = match.match_awayteam_score || 0;
      
      totalGoals += homeScore + awayScore;
      
      if (homeScore > awayScore) homeWins++;
      else if (awayScore > homeScore) awayWins++;
      else draws++;
    });

    const avgGoals = meetings.length > 0 ? totalGoals / meetings.length : 2.5;
    
    // Determine recent trend
    let recentTrend = 'Balanced';
    if (homeWins > awayWins + draws) recentTrend = 'Home dominant';
    else if (awayWins > homeWins + draws) recentTrend = 'Away dominant';
    else if (draws >= meetings.length * 0.4) recentTrend = 'Draw prone';

    return {
      totalMeetings: meetings.length,
      homeWins,
      awayWins,
      draws,
      avgGoals: Math.round(avgGoals * 10) / 10,
      recentTrend
    };
  }

  /**
   * üé≤ Generate betting predictions
   */
  private generatePredictions(teamStats: any, headToHead: any, match: any): BettingPrediction[] {
    const predictions: BettingPrediction[] = [];

    // 1. Match Result Prediction
    const matchResult = this.predictMatchResult(teamStats, headToHead);
    predictions.push(matchResult);

    // 2. Both Teams to Score
    const btts = this.predictBothTeamsScore(teamStats, headToHead);
    predictions.push(btts);

    // 3. Over/Under Goals
    const overUnder = this.predictOverUnder(teamStats, headToHead);
    predictions.push(overUnder);

    // 4. First Half Result (if confidence is high enough)
    if (matchResult.confidence > 70) {
      const firstHalf = this.predictFirstHalf(teamStats, matchResult);
      predictions.push(firstHalf);
    }

    return predictions;
  }

  /**
   * üèÜ Predict match result
   */
  private predictMatchResult(teamStats: any, headToHead: any): BettingPrediction {
    const { home, away } = teamStats;
    
    // Calculate win probabilities
    let homeProb = 33.33; // Base 33.33% each
    let awayProb = 33.33;
    let drawProb = 33.33;

    // Adjust for form and quality
    const homeBias = (home.winRate - away.winRate) + home.homeAdvantage - away.awayForm;
    
    homeProb += homeBias;
    awayProb -= homeBias * 0.7; // Away gets less penalty
    drawProb -= homeBias * 0.3;

    // Adjust for head-to-head
    if (headToHead.totalMeetings > 3) {
      const h2hHomeBias = ((headToHead.homeWins - headToHead.awayWins) / headToHead.totalMeetings) * 15;
      homeProb += h2hHomeBias;
      awayProb -= h2hHomeBias * 0.7;
      drawProb -= h2hHomeBias * 0.3;
    }

    // Normalize probabilities
    const total = homeProb + awayProb + drawProb;
    homeProb = (homeProb / total) * 100;
    awayProb = (awayProb / total) * 100;
    drawProb = (drawProb / total) * 100;

    // Determine prediction
    let prediction = 'HOME WIN';
    let confidence = homeProb;
    let reasoning = `Home advantage (${home.homeAdvantage}%) and better form`;

    if (awayProb > homeProb && awayProb > drawProb) {
      prediction = 'AWAY WIN';
      confidence = awayProb;
      reasoning = `Away team's superior form overcomes home advantage`;
    } else if (drawProb > homeProb && drawProb > awayProb) {
      prediction = 'DRAW';
      confidence = drawProb;
      reasoning = `Well-matched teams with similar statistics`;
    }

    return {
      type: 'match_result',
      prediction,
      confidence: Math.round(confidence),
      reasoning,
      odds_estimate: this.calculateOddsEstimate(confidence),
      risk_level: confidence > 65 ? 'LOW' : confidence > 55 ? 'MEDIUM' : 'HIGH'
    };
  }

  /**
   * ‚öΩ Predict both teams to score
   */
  private predictBothTeamsScore(teamStats: any, headToHead: any): BettingPrediction {
    const { home, away } = teamStats;
    
    // Calculate scoring probability for each team
    const homeScoreProb = Math.min((home.goalsFor / Math.max(home.goalsFor + home.goalsAgainst, 1)) * 100 + 20, 85);
    const awayScoreProb = Math.min((away.goalsFor / Math.max(away.goalsFor + away.goalsAgainst, 1)) * 100 + 15, 80);
    
    // Both teams score probability
    const bttsProb = (homeScoreProb * awayScoreProb) / 100;
    
    // Adjust for head-to-head goal average
    let h2hAdjustment = 0;
    if (headToHead.avgGoals > 2.5) h2hAdjustment = 10;
    else if (headToHead.avgGoals < 1.5) h2hAdjustment = -15;
    
    const finalProb = Math.max(Math.min(bttsProb + h2hAdjustment, 85), 15);
    
    const prediction = finalProb > 50 ? 'YES' : 'NO';
    const reasoning = finalProb > 50 
      ? `Both teams average good scoring rates (Home: ${(home.goalsFor/10).toFixed(1)}, Away: ${(away.goalsFor/10).toFixed(1)} goals/game)`
      : `Defensive-minded teams or poor attacking records suggest limited goals`;

    return {
      type: 'both_teams_score',
      prediction: `BOTH TEAMS TO SCORE: ${prediction}`,
      confidence: Math.round(Math.max(finalProb, 100 - finalProb)),
      reasoning,
      odds_estimate: this.calculateOddsEstimate(Math.max(finalProb, 100 - finalProb)),
      risk_level: Math.abs(finalProb - 50) > 20 ? 'LOW' : Math.abs(finalProb - 50) > 10 ? 'MEDIUM' : 'HIGH'
    };
  }

  /**
   * üìä Predict over/under goals
   */
  private predictOverUnder(teamStats: any, headToHead: any): BettingPrediction {
    const { home, away } = teamStats;
    
    // Calculate expected goals
    const homeExpected = (home.goalsFor / 10) + (away.goalsAgainst / 10);
    const awayExpected = (away.goalsFor / 10) + (home.goalsAgainst / 10);
    const totalExpected = (homeExpected + awayExpected) / 2;
    
    // Adjust for head-to-head average
    const h2hWeight = Math.min(headToHead.totalMeetings / 10, 0.3);
    const adjustedExpected = (totalExpected * (1 - h2hWeight)) + (headToHead.avgGoals * h2hWeight);
    
    const threshold = 2.5;
    const overProb = adjustedExpected > threshold ? 
      Math.min(60 + ((adjustedExpected - threshold) * 15), 80) :
      Math.max(40 - ((threshold - adjustedExpected) * 15), 20);
    
    const prediction = overProb > 50 ? 'OVER 2.5' : 'UNDER 2.5';
    const confidence = Math.round(Math.max(overProb, 100 - overProb));
    
    const reasoning = prediction.includes('OVER') 
      ? `Expected ${adjustedExpected.toFixed(1)} goals based on team averages and H2H`
      : `Low-scoring expectation (${adjustedExpected.toFixed(1)} goals) suggests under 2.5`;

    return {
      type: 'over_under',
      prediction: `${prediction} GOALS`,
      confidence,
      reasoning,
      odds_estimate: this.calculateOddsEstimate(confidence),
      risk_level: confidence > 65 ? 'LOW' : confidence > 55 ? 'MEDIUM' : 'HIGH'
    };
  }

  /**
   * üïê Predict first half result
   */
  private predictFirstHalf(teamStats: any, matchResult: BettingPrediction): BettingPrediction {
    // First half is typically more conservative
    let prediction = 'DRAW';
    let confidence = 45;
    
    if (matchResult.prediction === 'HOME WIN' && matchResult.confidence > 70) {
      prediction = 'HOME LEADING';
      confidence = Math.round(matchResult.confidence * 0.6);
    } else if (matchResult.prediction === 'AWAY WIN' && matchResult.confidence > 70) {
      prediction = 'AWAY LEADING';
      confidence = Math.round(matchResult.confidence * 0.6);
    }

    return {
      type: 'first_half',
      prediction: `FIRST HALF: ${prediction}`,
      confidence,
      reasoning: `Based on strong match prediction (${matchResult.confidence}% confidence)`,
      odds_estimate: this.calculateOddsEstimate(confidence),
      risk_level: confidence > 60 ? 'MEDIUM' : 'HIGH'
    };
  }

  /**
   * üìä Calculate overall match assessment
   */
  private calculateMatchAssessment(predictions: BettingPrediction[], teamStats: any) {
    const avgConfidence = predictions.reduce((sum, p) => sum + p.confidence, 0) / predictions.length;
    
    // Determine predictability
    let predictability: 'HIGH' | 'MEDIUM' | 'LOW' = 'MEDIUM';
    if (avgConfidence > 70) predictability = 'HIGH';
    else if (avgConfidence < 55) predictability = 'LOW';
    
    // Risk warning for low predictability
    let riskWarning;
    if (predictability === 'LOW') {
      riskWarning = 'This match has high uncertainty - consider smaller stakes';
    }

    return {
      predictability,
      overallConfidence: Math.round(avgConfidence),
      riskWarning
    };
  }

  /**
   * üí∞ Calculate odds estimate from confidence
   */
  private calculateOddsEstimate(confidence: number): string {
    const probability = confidence / 100;
    const odds = 1 / probability;
    
    if (odds < 1.5) return '1.20-1.50';
    else if (odds < 2) return '1.50-2.00';
    else if (odds < 3) return '2.00-3.00';
    else if (odds < 5) return '3.00-5.00';
    else return '5.00+';
  }

  /**
   * üñºÔ∏è Generate betting analysis image
   */
  private async generateBettingImage(analysis: BettingAnalysis): Promise<string | undefined> {
    const prompt = `Professional football betting analysis illustration: ${analysis.homeTeam} vs ${analysis.awayTeam} in ${analysis.competition}.
    Modern sports betting design with statistics display, confidence meters, prediction graphics, 
    odds analysis charts, professional betting aesthetic, clean infographic style, 
    team colors integration, statistical data visualization, high quality digital art.`;

    try {
      const generatedImage = await aiImageGenerator.generateImage({
        prompt: prompt,
        size: '1024x1024',
        quality: 'high'
      });
      
      if (!generatedImage) return undefined;

      // The AI image generator already handles upload to Supabase and returns a public URL
      return generatedImage.url;
    } catch (error) {
      console.error(`‚ùå Error generating betting image:`, error);
      return undefined;
    }
  }

  /**
   * üìù Generate betting content with AI editing
   */
  private async generateBettingContent(analysis: BettingAnalysis, language: 'en' | 'am' | 'sw'): Promise<{
    content: string;
    aiEditedContent: string;
  }> {
    // Generate base content
    const content = this.generateBaseContent(analysis, language);
    
    // AI edit for quality and engagement
    const aiEditedContent = await this.aiEditBettingContent(content, analysis, language);
    
    return { content, aiEditedContent };
  }

  /**
   * üìÑ Generate base betting content
   */
  private generateBaseContent(analysis: BettingAnalysis, language: 'en' | 'am' | 'sw'): string {
    const { homeTeam, awayTeam, competition, predictions, matchAssessment, teamStats } = analysis;
    
    if (language === 'en') {
      let content = `üéØ BETTING ANALYSIS: ${homeTeam} vs ${awayTeam}\n\n`;
      content += `üèÜ Competition: ${competition}\n`;
      content += `üìä Overall Confidence: ${matchAssessment.overallConfidence}%\n`;
      content += `üé≤ Predictability: ${matchAssessment.predictability}\n\n`;
      
      content += `üìà TEAM FORM:\n`;
      content += `üè† ${homeTeam}: ${teamStats.home.form} (${teamStats.home.winRate}% win rate)\n`;
      content += `‚úàÔ∏è ${awayTeam}: ${teamStats.away.form} (${teamStats.away.winRate}% win rate)\n\n`;
      
      content += `üí° PREDICTIONS:\n`;
      predictions.forEach((pred, index) => {
        content += `${index + 1}. ${pred.prediction}\n`;
        content += `   üìä Confidence: ${pred.confidence}%\n`;
        content += `   üí∞ Est. Odds: ${pred.odds_estimate}\n`;
        content += `   ‚ö†Ô∏è Risk: ${pred.risk_level}\n`;
        content += `   üìù Reasoning: ${pred.reasoning}\n\n`;
      });
      
      if (matchAssessment.riskWarning) {
        content += `‚ö†Ô∏è RISK WARNING: ${matchAssessment.riskWarning}\n\n`;
      }
      
      return content;
    }
    
    if (language === 'am') {
      let content = `üéØ ·ã®·ãç·à≠·à≠·ãµ ·âµ·äï·â≥·äî: ${homeTeam} ·â†·â∞·âÉ ${awayTeam}\n\n`;
      content += `üèÜ ·ãç·ãµ·ãµ·à≠: ${competition}\n`;
      content += `üìä ·ä†·å†·âÉ·àã·ã≠ ·ä•·àù·äê·âµ: ${matchAssessment.overallConfidence}%\n`;
      content += `üé≤ ·âµ·äï·â†·ã´: ${matchAssessment.predictability}\n\n`;
      
      content += `üìà ·ã®·â°·ãµ·äï ·àÅ·äî·â≥:\n`;
      content += `üè† ${homeTeam}: ${teamStats.home.form} (${teamStats.home.winRate}% ·ã´·à∏·äê·çà)\n`;
      content += `‚úàÔ∏è ${awayTeam}: ${teamStats.away.form} (${teamStats.away.winRate}% ·ã´·à∏·äê·çà)\n\n`;
      
      content += `üí° ·âµ·äï·â†·ã´·ãé·âΩ:\n`;
      predictions.forEach((pred, index) => {
        // Translate basic prediction types to Amharic
        const translatedPrediction = this.translatePrediction(pred.prediction, 'am');
        const translatedReasoning = this.translateReasoning(pred.reasoning, 'am');
        
        content += `${index + 1}. ${translatedPrediction}\n`;
        content += `   üìä ·ä•·àù·äê·âµ: ${pred.confidence}%\n`;
        content += `   üí∞ ·åç·àù·âµ: ${pred.odds_estimate}\n`;
        content += `   ‚ö†Ô∏è ·àµ·åã·âµ: ${pred.risk_level}\n`;
        content += `   üìù ·àù·ä≠·äï·ã´·âµ: ${translatedReasoning}\n\n`;
      });
      
      if (matchAssessment.riskWarning) {
        content += `‚ö†Ô∏è ·ã®·àµ·åã·âµ ·àõ·àµ·å†·äï·âÄ·âÇ·ã´: ${matchAssessment.riskWarning}\n\n`;
      }
      
      return content;
    }
    
    if (language === 'sw') {
      let content = `üéØ UCHAMBUZI WA KAMARI: ${homeTeam} dhidi ya ${awayTeam}\n\n`;
      content += `üèÜ Ushindani: ${competition}\n`;
      content += `üìä Uongozi Jumla: ${matchAssessment.overallConfidence}%\n`;
      content += `üé≤ Ubashiri: ${matchAssessment.predictability}\n\n`;
      
      content += `üìà HALI YA TIMU:\n`;
      content += `üè† ${homeTeam}: ${teamStats.home.form} (${teamStats.home.winRate}% kushinda)\n`;
      content += `‚úàÔ∏è ${awayTeam}: ${teamStats.away.form} (${teamStats.away.winRate}% kushinda)\n\n`;
      
      content += `üí° UBASHIRI:\n`;
      predictions.forEach((pred, index) => {
        // Translate basic prediction types to Swahili
        const translatedPrediction = this.translatePrediction(pred.prediction, 'sw');
        const translatedReasoning = this.translateReasoning(pred.reasoning, 'sw');
        
        content += `${index + 1}. ${translatedPrediction}\n`;
        content += `   üìä Uongozi: ${pred.confidence}%\n`;
        content += `   üí∞ Nasibu: ${pred.odds_estimate}\n`;
        content += `   ‚ö†Ô∏è Hatari: ${pred.risk_level}\n`;
        content += `   üìù Sababu: ${translatedReasoning}\n\n`;
      });
      
      if (matchAssessment.riskWarning) {
        content += `‚ö†Ô∏è ONYO LA HATARI: ${matchAssessment.riskWarning}\n\n`;
      }
      
      return content;
    }
    
    // Fallback to English
    return `üéØ ${homeTeam} vs ${awayTeam} - ${competition}\n\nBetting analysis with ${matchAssessment.overallConfidence}% confidence.\n\nPredictions and analysis available.`;
  }

  /**
   * ü§ñ AI edit betting content - REAL AI INTEGRATION
   */
  private async aiEditBettingContent(content: string, analysis: BettingAnalysis, language: 'en' | 'am' | 'sw'): Promise<string> {
    console.log(`ü§ñ AI editing betting content for language: ${language}`);
    
    try {
      const openai = await getOpenAIClient();
      if (!openai) {
        console.log('‚ùå OpenAI client not available, using template-based editing');
        return this.enhanceBettingContent(content, analysis, language);
      }

      const systemPrompts = {
        'en': `You are a professional football betting analyst. Create engaging, informative betting analysis content of exactly 4-6 lines. Include relevant emojis and responsible gambling reminders.`,
        'am': `You are a professional football betting analyst writing in AMHARIC language. You MUST write EVERYTHING in Amharic script - including all content and text. Never use English words. Create engaging betting analysis content of exactly 4-6 lines in Amharic only.`,
        'sw': `You are a professional football betting analyst writing in SWAHILI language. You MUST write EVERYTHING in Swahili - including all content and text. Never use English words. Create engaging betting analysis content of exactly 4-6 lines in Swahili only.`
      };

      // Build comprehensive analysis data for AI
      const analysisData = {
        teams: `${analysis.homeTeam} vs ${analysis.awayTeam}`,
        competition: analysis.competition,
        confidence: analysis.matchAssessment.overallConfidence,
        predictability: analysis.matchAssessment.predictability,
        homeTeamStats: {
          form: analysis.teamStats.home.form,
          winRate: analysis.teamStats.home.winRate,
          goalsFor: analysis.teamStats.home.goalsFor,
          goalsAgainst: analysis.teamStats.home.goalsAgainst,
          homeAdvantage: analysis.teamStats.home.homeAdvantage
        },
        awayTeamStats: {
          form: analysis.teamStats.away.form,
          winRate: analysis.teamStats.away.winRate,
          goalsFor: analysis.teamStats.away.goalsFor,
          goalsAgainst: analysis.teamStats.away.goalsAgainst,
          awayForm: analysis.teamStats.away.awayForm
        },
        headToHead: {
          totalMeetings: analysis.headToHead.totalMeetings,
          homeWins: analysis.headToHead.homeWins,
          awayWins: analysis.headToHead.awayWins,
          draws: analysis.headToHead.draws,
          avgGoals: analysis.headToHead.avgGoals,
          recentTrend: analysis.headToHead.recentTrend
        },
        topPredictions: analysis.predictions.slice(0, 3).map(pred => ({
          prediction: pred.prediction,
          confidence: pred.confidence,
          reasoning: pred.reasoning,
          risk: pred.risk_level
        })),
        riskWarning: analysis.matchAssessment.riskWarning
      };

      const languageInstructions = {
        'en': `Create engaging betting analysis content using this comprehensive data. Write exactly 4-6 lines. Include the confidence percentage, key team stats, and top predictions. Add relevant emojis and responsible gambling reminder:`,
        'am': `·ã≠·àÖ·äï ·à∞·çä ·àò·à®·åÉ ·â†·àò·å†·âÄ·àù ·ä†·à≥·â≥·çä ·ã®·ãç·à≠·à≠·ãµ ·âµ·äï·â≥·äî ·ã≠·ãò·âµ ·çç·å†·à≠·ç¢ ·â†·âµ·ä≠·ä≠·àç 4-6 ·àò·àµ·àò·àÆ·âΩ ·â•·âª ·åª·çç·ç¢ ·ã®·ä•·àù·äê·âµ ·àò·â∂·äõ·ç£ ·âÅ·àç·çç ·ã®·â°·ãµ·äï ·àµ·â≥·â≤·àµ·â≤·ä≠·àµ ·ä•·äì ·âÄ·ã≥·àö ·âµ·äï·â†·ã´·ãé·âΩ ·ä†·ä´·âµ·âµ·ç¢ ·àµ·àú·âµ ·åà·àã·å≠ ·àù·àç·ä≠·â∂·âΩ ·ä•·äì ·ã®·äÉ·àã·çä·äê·âµ ·ãç·à≠·à≠·ãµ ·àõ·àµ·â≥·ãà·àª ·å®·àù·à≠·ç¢ ·àÅ·àâ·àù ·äê·åà·à≠ ·â†·ä†·àõ·à≠·äõ ·â•·âª ·àò·àÜ·äï ·ä†·àà·â†·âµ·ç°`,
        'sw': `Unda maudhui ya uchambuzi wa kamari ya kuvutia kwa kutumia data hii ya kina. Andika mistari 4-6 tu haswa. Jumuisha asilimia ya imani, takwimu muhimu za timu na utabiri wa juu. Ongeza alama za hisia na kikumbusho cha kamari ya uwajibikaji. Kila kitu kiwe kwa Kiswahili tu:`
      };

      const response = await openai.chat.completions.create({
        model: "gpt-4",
        messages: [
          { 
            role: "system", 
            content: systemPrompts[language]
          },
          { 
            role: "user", 
            content: `${languageInstructions[language]}\n\nAnalysis Data:\n${JSON.stringify(analysisData, null, 2)}` 
          }
        ],
        max_tokens: language === 'en' ? 400 : 500, // More tokens for other languages
        temperature: 0.7
      });

      const enhancedContent = response.choices[0]?.message?.content?.trim();
      
      if (enhancedContent) {
        console.log(`‚úÖ AI enhanced betting content in ${language}: "${enhancedContent.substring(0, 100)}..."`);
        return enhancedContent;
      }
      
    } catch (error) {
      console.error('‚ùå Error enhancing betting content with AI:', error);
    }
    
    // Fallback to template-based editing
    return this.enhanceBettingContent(content, analysis, language);
  }

  /**
   * ‚ú® Enhance betting content with engaging format
   */
  private enhanceBettingContent(content: string, analysis: BettingAnalysis, language: 'en' | 'am' | 'sw'): string {
    if (language === 'en') {
      return `${content}üî• Don't miss this ${analysis.matchAssessment.predictability.toLowerCase()}-confidence betting opportunity!\n\nüí° Remember: Bet responsibly and only what you can afford to lose!\n\n#BettingTips #Football #${analysis.homeTeam.replace(/\s+/g, '')} #${analysis.awayTeam.replace(/\s+/g, '')}`;
    }
    
    if (language === 'am') {
      return `${content}üî• ·ã≠·àÖ·äï ·ã®${analysis.matchAssessment.predictability.toLowerCase()}-·ä•·àù·äê·âµ ·ã®·ãç·à≠·à≠·ãµ ·ä•·ãµ·àç ·ä†·â≥·àò·àç·å°·âµ!\n\nüí° ·ã´·àµ·â≥·ãç·à±: ·â†·äÉ·àã·çä·äê·âµ ·ã≠·ãã·à®·ã± ·ä•·äì ·àõ·å£·âµ ·ã®·àö·âΩ·àâ·âµ·äï ·â•·âª!\n\n#·ã®·ãç·à≠·à≠·ãµ·å†·âÉ·àö #·ä•·åç·à≠·ä≥·àµ #${analysis.homeTeam.replace(/\s+/g, '')} #${analysis.awayTeam.replace(/\s+/g, '')}`;
    }
    
    if (language === 'sw') {
      return `${content}üî• Usikose fursa hii ya kamari ya ${analysis.matchAssessment.predictability.toLowerCase()}-uongozi!\n\nüí° Kumbuka: Weka kamari kwa busara na kile unachoweza kupoteza tu!\n\n#KamariTips #Mpira #${analysis.homeTeam.replace(/\s+/g, '')} #${analysis.awayTeam.replace(/\s+/g, '')}`;
    }
    
    return content;
  }

  /**
   * ‚ö†Ô∏è Get responsible gambling disclaimers
   */
  private getDisclaimers(language: 'en' | 'am' | 'sw'): string[] {
    const disclaimers = {
      en: [
        '‚ö†Ô∏è 18+ Only - Gambling can be addictive',
        'üí∞ Never bet more than you can afford to lose',
        'üìö This analysis is for educational purposes only',
        'üö´ No guarantees - all bets carry risk',
        'üÜò Problem gambling? Get help: www.begambleaware.org',
        'üìä Past performance does not guarantee future results'
      ],
      am: [
        '‚ö†Ô∏è 18+ ·â•·âª - ·ãç·à≠·à≠·ãµ ·à±·àµ ·àä·çà·å•·à≠ ·ã≠·âΩ·àã·àç',
        'üí∞ ·àõ·å£·âµ ·ã®·àõ·âµ·âΩ·àà·ãç·äï ·àò·å†·äï ·â†·àã·ã≠ ·ä†·âµ·ãã·à®·ãµ',
        'üìö ·ã≠·àÖ ·âµ·äï·â≥·äî ·àà·âµ·àù·àÖ·à≠·âµ ·ãì·àã·àõ ·â•·âª ·äê·ãç',
        'üÜò ·ã®·ãç·à≠·à≠·ãµ ·âΩ·åç·à≠? ·ä•·à≠·ã≥·â≥ ·ã´·åç·äô'
      ],
      sw: [
        '‚ö†Ô∏è Umri 18+ pekee - Kamari inaweza kuwa hatari',
        'üí∞ Usiweke zaidi ya unachoweza kupoteza',
        'üìö Uchambuzi huu ni kwa madhumuni ya kielimu tu',
        'üÜò Matatizo ya kamari? Pata msaada'
      ]
    };
    
    return disclaimers[language];
  }

  /**
   * ‚úÖ Mark content as used for uniqueness
   */
  private async markContentAsUsed(analysis: BettingAnalysis, channelId: string): Promise<void> {
    try {
      const { error } = await supabase
        .from('content_uniqueness')
        .insert({
          content_id: `${analysis.homeTeam}_${analysis.awayTeam}_${Date.now()}`,
          channel_id: channelId,
          content_type: 'betting_tip',
          used_at: new Date().toISOString(),
          variation_token: `BETTING_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
        });

      if (error) {
        console.error(`‚ùå Error marking betting content as used:`, error);
      }
    } catch (error) {
      console.error(`‚ùå Error in markContentAsUsed:`, error);
    }
  }

  /**
   * üîç Get latest betting opportunities
   */
  async getLatestBettingOpportunities(language: 'en' | 'am' | 'sw' = 'en', limit: number = 3): Promise<BettingAnalysis[]> {
    const opportunities: BettingAnalysis[] = [];
    
    try {
      // Get multiple matches for analysis
      const analysisResults = await unifiedFootballService.getMatchesForContentType('betting_tip', language, limit * 2);
      
      for (const match of analysisResults.matches.slice(0, limit)) {
        const analysis = await this.performBettingAnalysis(match);
        if (analysis.matchAssessment.overallConfidence >= 60) {
          opportunities.push(analysis);
        }
      }
    } catch (error) {
      console.error(`‚ùå Error getting betting opportunities:`, error);
    }
    
    return opportunities;
  }

  /**
   * üìä Get betting statistics
   */
  async getBettingStats(): Promise<{
    totalAnalyzed: number;
    highConfidence: number;
    mediumConfidence: number;
    lowConfidence: number;
    avgConfidence: number;
  }> {
    // This would connect to database to get actual stats
    // For now, returning mock data
    return {
      totalAnalyzed: 0,
      highConfidence: 0,
      mediumConfidence: 0,
      lowConfidence: 0,
      avgConfidence: 0
    };
  }

  /**
   * üåê Translate prediction text to target language
   */
  private translatePrediction(prediction: string, language: 'en' | 'am' | 'sw'): string {
    if (language === 'en') return prediction;
    
    // Basic translations for common predictions
    const translations = {
      am: {
        'Home Win': '·ã®·â§·âµ ·â°·ãµ·äï ·ã´·à∏·äï·çã·àç',
        'Away Win': '·ã®·ä•·äï·åç·ãµ ·â°·ãµ·äï ·ã´·à∏·äï·çã·àç', 
        'Draw': '·ä•·ä©·àç ·ã≠·â†·à≠·à´·àç',
        'Both Teams to Score': '·àÅ·àà·â±·àù ·â°·ãµ·äñ·âΩ ·ã≠·àò·ãò·åà·â£·àâ',
        'Over 2.5 Goals': '·ä®2.5 ·åé·àé·âΩ ·â†·àã·ã≠',
        'Under 2.5 Goals': '·ä®2.5 ·åé·àé·âΩ ·â†·â≥·âΩ',
        'First Half Win': '·ã®·àò·åÄ·àò·à™·ã´ ·åç·àõ·àΩ ·åä·ãú ·ã´·à∏·äï·çã·àç'
      },
      sw: {
        'Home Win': 'Timu ya nyumbani kushinda',
        'Away Win': 'Timu ya nje kushinda',
        'Draw': 'Sare',
        'Both Teams to Score': 'Timu zote mbili kutunga',
        'Over 2.5 Goals': 'Zaidi ya magoli 2.5',
        'Under 2.5 Goals': 'Chini ya magoli 2.5',
        'First Half Win': 'Ushindi wa kipindi cha kwanza'
      }
    };

    // Try to find exact match or partial match
    const langTranslations = translations[language];
    for (const [english, translated] of Object.entries(langTranslations)) {
      if (prediction.includes(english)) {
        return prediction.replace(english, translated);
      }
    }
    
    return prediction; // Return original if no translation found
  }

  /**
   * üåê Translate reasoning text to target language  
   */
  private translateReasoning(reasoning: string, language: 'en' | 'am' | 'sw'): string {
    if (language === 'en') return reasoning;
    
    // Basic phrase translations
    const phrases = {
      am: {
        'Strong home form': '·å†·äï·ä´·à´ ·ã®·â§·âµ ·àÅ·äî·â≥',
        'Good away record': '·å•·à© ·ã®·ä•·äï·åç·ãµ ·ãç·å§·âµ',
        'High-scoring teams': '·åé·àç ·ã®·àö·à∞·à© ·â°·ãµ·äñ·âΩ',
        'Defensive teams': '·àò·ä®·àã·ä®·ã´ ·â°·ãµ·äñ·âΩ',
        'Recent form favors': '·ã®·âÖ·à≠·â• ·åä·ãú ·àÅ·äî·â≥ ·ã≠·ã∞·åç·çã·àç',
        'Head-to-head record': '·âÄ·å•·â≥ ·ãç·ãµ·ãµ·à≠ ·à™·ä®·à≠·ãµ'
      },
      sw: {
        'Strong home form': 'Uongozi mkuu wa nyumbani',
        'Good away record': 'Rekodi nzuri ya nje',
        'High-scoring teams': 'Timu zenye kutunga mengi',
        'Defensive teams': 'Timu za ulinzi',
        'Recent form favors': 'Hali ya hivi karibuni inapendekeza',
        'Head-to-head record': 'Rekodi ya moja kwa moja'
      }
    };

    let translatedReasoning = reasoning;
    const langPhrases = phrases[language];
    
    for (const [english, translated] of Object.entries(langPhrases)) {
      translatedReasoning = translatedReasoning.replace(english, translated);
    }
    
    return translatedReasoning;
  }
}

// Export singleton instance
export const bettingTipsGenerator = new BettingTipsGenerator();