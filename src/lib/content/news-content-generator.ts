/**
 * üì∞ OPTIMIZED NEWS CONTENT GENERATOR
 * 
 * Performance improvements:
 * - Parallel RSS fetching with timeout
 * - Caching for RSS feeds
 * - Batch processing for scoring
 * - Smart image handling
 * - Optimized AI calls
 */

import { unifiedFootballService } from './unified-football-service';
import { aiImageGenerator } from './ai-image-generator';
import { supabase } from '@/lib/supabase';
import { rssNewsFetcher, RSSItem } from './rss-news-fetcher';
import { getOpenAIClient } from '../api-keys';
import { contentSpamPreventer } from '../utils/content-spam-preventer';

// Cache for RSS feeds
const RSS_CACHE = new Map<string, { data: NewsItem[], timestamp: number }>();
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

export interface NewsItem {
  id: string;
  title: string;
  description: string;
  content: string;
  imageUrl?: string;
  sourceUrl: string;
  publishedAt: string;
  source: string;
  category: string;
  relevanceScore?: number;
}

export interface NewsGenerationRequest {
  language: 'en' | 'am' | 'sw';
  channelId: string;
  maxResults?: number;
  excludeUsedContent?: boolean;
  
  // üéØ NEW: Channel-specific targeting for personalized news content
  selectedLeagues?: string[];
  selectedTeams?: string[];
  channelName?: string;
}

export interface GeneratedNews {
  title: string;
  content: string;
  imageUrl?: string;
  sourceUrl: string;
  aiEditedContent?: string;
  metadata: {
    language: string;
    source: string;
    contentId: string;
    generatedAt: string;
    relevanceScore: number;
    detailsUrl?: string;
    telegramEnhancements?: {
      protectContent?: boolean;
      enableShareButton?: boolean;
      enableWebApp?: boolean;
      priority?: string;
      spoilerImage?: boolean;
      disablePreview?: boolean;
    };
  };
}

export class OptimizedNewsContentGenerator {
  private scoreCache = new Map<string, number>();
  private usedContentCache = new Map<string, Set<string>>();
  private cacheTimeout = 10 * 60 * 1000; // 10 minutes

  /**
   * üéØ MAIN FUNCTION - Generate news content (OPTIMIZED)
   */
  async generateNewsContent(request: NewsGenerationRequest): Promise<GeneratedNews | null> {
    console.log(`üì∞ Generating news content in ${request.language}`);
    const startTime = Date.now();
    
    try {
      // Step 1: Get RSS news feeds (with caching)
      const rssNews = await this.fetchRSSNewsOptimized();
      if (rssNews.length === 0) {
        console.log(`‚ùå No RSS news found, attempting AI-generated fallback news`);
        return await this.generateFallbackNewsContent(request);
      }
      console.log(`‚úÖ Fetched ${rssNews.length} news items in ${Date.now() - startTime}ms`);

      // Step 2: Score and rank news items with channel preferences (batch processing)
      const scoredNews = this.scoreAndRankNewsOptimized(rssNews, request);
      
      // Step 3: Check uniqueness and get best unused news
      const bestNews = await this.getBestUnusedNewsOptimized(scoredNews, request.channelId);
      if (!bestNews) {
        console.log(`‚ùå No new/unused news found`);
        return null;
      }

      console.log(`‚úÖ Selected news: "${bestNews.title}" (Score: ${bestNews.relevanceScore})`);

      // üîÑ STEP 3.5: Check if similar content was recently generated (SAVE OPENAI CALLS!)
      const canGenerate = await contentSpamPreventer.canGenerateContent(
        'news',
        request.channelId,
        bestNews.title
      );
      
      if (!canGenerate.allowed) {
        console.log(`üîÑ DUPLICATE PREVENTION: ${canGenerate.reason}`);
        // Return the existing content instead of generating new
        if (canGenerate.duplicateContent?.details?.content) {
          return {
            title: canGenerate.duplicateContent.details.title || bestNews.title,
            content: canGenerate.duplicateContent.details.content,
            imageUrl: canGenerate.duplicateContent.details.imageUrl,
            metadata: {
              language: request.language,
              generatedAt: new Date().toISOString(),
              contentId: bestNews.id,
              source: bestNews.source,
              relevanceScore: bestNews.relevanceScore,
              detailsUrl: bestNews.url,
              duplicateFlag: true, // Mark as duplicate to avoid OpenAI call
              telegramEnhancements: {
                protectContent: request.language !== 'en',
                enableShareButton: true,
                enableWebApp: false,
                priority: 'high',
                spoilerImage: false,
                disablePreview: false
              }
            }
          };
        } else {
          console.log(`‚ùå Duplicate content found but no content details - skipping generation`);
          return null;
        }
      }

      console.log(`‚úÖ CONTENT GENERATION APPROVED: Proceeding with OpenAI call`);

      // Step 4 & 5: Handle image and AI edit in parallel
      const [imageUrl, aiEditedContent] = await Promise.all([
        this.handleNewsImageOptimized(bestNews),
        this.aiEditNewsContentOptimized(bestNews, request.language)
      ]);
      
      // Step 6: Mark content as used (async, don't wait)
      this.markContentAsUsed(bestNews.id, request.channelId).catch(err => 
        console.error('Error marking content as used:', err)
      );

      const totalTime = Date.now() - startTime;
      console.log(`‚úÖ News generation completed in ${totalTime}ms`);

      return {
        title: bestNews.title,
        content: aiEditedContent,
        imageUrl,
        sourceUrl: bestNews.sourceUrl,
        aiEditedContent,
        metadata: {
          language: request.language,
          source: bestNews.source,
          contentId: bestNews.id,
          generatedAt: new Date().toISOString(),
          relevanceScore: bestNews.relevanceScore || 0,
          // üì∞ Enhanced Telegram Features for News
          detailsUrl: bestNews.sourceUrl,
          telegramEnhancements: {
            protectContent: (bestNews.relevanceScore || 0) >= 85,  // üõ°Ô∏è Protect high-value exclusive news
            enableShareButton: true,  // üì§ Share breaking news
            enableWebApp: false,  // No web app for news
            priority: (bestNews.relevanceScore || 0) >= 80 ? 'high' : 'normal',
            spoilerImage: bestNews.title?.toLowerCase().includes('transfer') || 
                         bestNews.title?.toLowerCase().includes('breaking'),  // üôà Spoiler for transfers/breaking
            disablePreview: false  // Show link preview for news
          }
        }
      };

    } catch (error) {
      console.error(`‚ùå Error generating news content:`, error);
      return null;
    }
  }

  /**
   * üì° OPTIMIZED: Fetch RSS with caching and timeout
   */
  private async fetchRSSNewsOptimized(): Promise<NewsItem[]> {
    const cacheKey = 'all-feeds';
    const cached = RSS_CACHE.get(cacheKey);
    
    // Return cached data if fresh
    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
      console.log('üì∞ Using cached RSS feeds');
      return cached.data;
    }

    console.log(`üì° Fetching fresh RSS feeds`);
    
    try {
      // Fetch with longer timeout and retry logic
      const fetchPromise = this.fetchWithRetry();
      const timeoutPromise = new Promise<RSSItem[]>((_, reject) => 
        setTimeout(() => reject(new Error('RSS fetch timeout')), 30000) // ◊î◊ê◊®◊õ◊™ timeout ◊ú-30 ◊©◊†◊ô◊ï◊™
      );
      
      const rssItems = await Promise.race([fetchPromise, timeoutPromise]);
      
      // Convert to NewsItem format
      const newsItems: NewsItem[] = rssItems.map(rssItem => ({
        id: rssItem.id,
        title: rssItem.title,
        description: rssItem.description,
        content: rssItem.content,
        imageUrl: rssItem.imageUrl,
        sourceUrl: rssItem.link,
        publishedAt: rssItem.pubDate,
        source: rssItem.source,
        category: rssItem.category || 'Football'
      }));

      // Cache the results
      RSS_CACHE.set(cacheKey, { data: newsItems, timestamp: Date.now() });
      
      console.log(`üì∞ Fetched and cached ${newsItems.length} news items`);
      return newsItems;
      
    } catch (error) {
      console.error(`‚ùå Error fetching RSS news:`, error);
      // Return cached data even if expired
      const expiredCached = RSS_CACHE.get(cacheKey);
      if (expiredCached && expiredCached.data.length > 0) {
        console.log('üì∞ Using expired cached RSS feeds as fallback');
        return expiredCached.data;
      }
      
      // DON'T use fallback data - return empty array so system returns null
      console.log('‚ùå No RSS feeds available and no cache - returning empty array');
      return [];
    }
  }

  /**
   * üîÑ Fetch with retry logic
   */
  private async fetchWithRetry(maxRetries: number = 2): Promise<RSSItem[]> {
    let lastError: any;
    
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        console.log(`üì° RSS fetch attempt ${attempt}/${maxRetries}`);
        const result = await rssNewsFetcher.fetchAllFeeds();
        
        if (result.length > 0) {
          console.log(`‚úÖ RSS fetch successful on attempt ${attempt}`);
          return result;
        }
        
        // If no items found, try again (unless last attempt)
        if (attempt < maxRetries) {
          console.log(`‚ö†Ô∏è No RSS items found, retrying in 3 seconds...`);
          await new Promise(resolve => setTimeout(resolve, 3000));
        }
        
      } catch (error) {
        lastError = error;
        console.error(`‚ùå RSS fetch attempt ${attempt} failed:`, error);
        
        if (attempt < maxRetries) {
          console.log(`üîÑ Retrying in 5 seconds...`);
          await new Promise(resolve => setTimeout(resolve, 5000));
        }
      }
    }
    
    throw lastError || new Error('All RSS fetch attempts failed');
  }

  /**
   * üèÜ OPTIMIZED: Score with caching, batch processing and channel preferences
   */
  private scoreAndRankNewsOptimized(newsItems: NewsItem[], request?: NewsGenerationRequest): NewsItem[] {
    console.log(`üèÜ Scoring ${newsItems.length} news items${request?.channelName ? ` for channel: ${request.channelName}` : ''}`);
    
    if (request?.selectedTeams?.length || request?.selectedLeagues?.length) {
      console.log(`üéØ Channel preferences: ${request.selectedTeams?.length || 0} teams, ${request.selectedLeagues?.length || 0} leagues`);
    }
    
    // Pre-compile regex patterns for better performance
    const patterns = {
      premierLeague: /premier league/i,
      championsLeague: /champions league|uefa/i,
      europaLeague: /europa league/i,
      worldCup: /world cup|fifa/i,
      euro: /euro 202[4-9]|european championship/i,
      goal: /goal|score/i,
      hatTrick: /hat[\s-]?trick/i,
      penalty: /penalty|red card/i,
      derby: /derby|classico/i,
      transfer: /transfer|signing/i,
      contract: /contract|deal/i,
      money: /million|[‚Ç¨¬£$]/,
      final: /final|semi-final/i,
      quarterFinal: /quarter-final|playoff/i,
      title: /title|championship/i,
      manager: /manager|coach/i,
      injury: /injury|injured/i,
      suspension: /suspension|banned/i
    };

    const topTeams = new Set([
      'manchester city', 'arsenal', 'liverpool', 'chelsea', 'manchester united',
      'real madrid', 'barcelona', 'bayern munich', 'psg', 'juventus'
    ]);

    const premiumSources = new Set(['bbc', 'sky sports', 'guardian', 'reuters', 'espn']);
    const goodSources = new Set(['talksport', 'goal', 'marca', 'as']);
    
    const scoredNews = newsItems.map(news => {
      // Check cache first
      const cacheKey = news.id;
      if (this.scoreCache.has(cacheKey)) {
        return { ...news, relevanceScore: this.scoreCache.get(cacheKey) };
      }

      let score = 0;
      const fullText = `${news.title} ${news.content} ${news.description}`.toLowerCase();
      
      // Competition scoring
      if (patterns.premierLeague.test(fullText)) score += 15;
      if (patterns.championsLeague.test(fullText)) score += 15;
      if (patterns.europaLeague.test(fullText)) score += 12;
      if (patterns.worldCup.test(fullText)) score += 20;
      if (patterns.euro.test(fullText)) score += 18;
      
      // Team scoring (optimized)
      for (const team of topTeams) {
        if (fullText.includes(team)) {
          score += 10;
          break; // One team match is enough
        }
      }
      
      // üéØ CHANNEL-SPECIFIC TEAM PREFERENCES (High Priority Scoring)
      if (request?.selectedTeams?.length) {
        for (const preferredTeam of request.selectedTeams) {
          // Get team name from database or use ID as fallback
          const teamName = preferredTeam.toLowerCase();
          if (fullText.includes(teamName)) {
            score += 25; // Higher score for channel's preferred teams
            console.log(`üéØ Boosted score (+25) for preferred team: ${preferredTeam}`);
          }
        }
      }
      
      // üéØ CHANNEL-SPECIFIC LEAGUE PREFERENCES  
      if (request?.selectedLeagues?.length) {
        // This would need league name mapping from database
        // For now, give a small boost if it's a major league
        const hasPreferredLeague = request.selectedLeagues.some(leagueId => {
          // Simple check - in production would map league IDs to names
          return patterns.premierLeague.test(fullText) || 
                 patterns.championsLeague.test(fullText) ||
                 patterns.europaLeague.test(fullText);
        });
        
        if (hasPreferredLeague) {
          score += 15; // Boost for preferred leagues
          console.log(`üéØ Boosted score (+15) for preferred league content`);
        }
      }
      
      // Event scoring
      if (patterns.goal.test(fullText)) score += 8;
      if (patterns.hatTrick.test(fullText)) score += 12;
      if (patterns.penalty.test(fullText)) score += 7;
      if (patterns.derby.test(fullText)) score += 10;
      if (patterns.transfer.test(fullText)) score += 8;
      if (patterns.contract.test(fullText)) score += 6;
      if (patterns.money.test(fullText)) score += 5;
      if (patterns.final.test(fullText)) score += 12;
      if (patterns.quarterFinal.test(fullText)) score += 8;
      if (patterns.title.test(fullText)) score += 10;
      if (patterns.manager.test(fullText)) score += 6;
      if (patterns.injury.test(fullText)) score += 5;
      if (patterns.suspension.test(fullText)) score += 6;
      
      // Recency scoring (optimized calculation)
      const hoursAgo = (Date.now() - new Date(news.publishedAt).getTime()) / 3600000;
      if (hoursAgo < 1) score += 15;
      else if (hoursAgo < 3) score += 12;
      else if (hoursAgo < 6) score += 10;
      else if (hoursAgo < 12) score += 8;
      else if (hoursAgo < 24) score += 6;
      else if (hoursAgo < 48) score += 3;
      
      // Image bonus
      if (news.imageUrl) score += 5;
      
      // Source scoring (optimized)
      const sourceLower = news.source.toLowerCase();
      if ([...premiumSources].some(s => sourceLower.includes(s))) score += 8;
      else if ([...goodSources].some(s => sourceLower.includes(s))) score += 5;
      
      // Content quality
      const contentLength = news.content.length;
      if (contentLength > 300) score += 4;
      if (contentLength > 500) score += 2;
      
      // Category bonus
      if (news.category === 'Premier League') score += 8;
      if (news.category === 'Champions League') score += 8;
      if (news.category === 'Transfer News') score += 6;

      // Cache the score
      this.scoreCache.set(cacheKey, score);

      return { ...news, relevanceScore: score };
    });

    // Sort by relevance score
    return scoredNews.sort((a, b) => (b.relevanceScore || 0) - (a.relevanceScore || 0));
  }

  /**
   * üîç OPTIMIZED: Get best unused news with caching
   */
  private async getBestUnusedNewsOptimized(scoredNews: NewsItem[], channelId: string): Promise<NewsItem | null> {
    console.log(`üîç Finding best unused news for channel ${channelId}`);
    
    // Get cached used content IDs
    let usedContentIds = this.usedContentCache.get(channelId);
    
    if (!usedContentIds) {
      const ids = await this.getUsedContentIds(channelId);
      usedContentIds = new Set(ids);
      this.usedContentCache.set(channelId, usedContentIds);
      
      // Clear cache after timeout
      setTimeout(() => this.usedContentCache.delete(channelId), this.cacheTimeout);
    }
    
    // Find first unused news
    for (const news of scoredNews) {
      if (!usedContentIds.has(news.id)) {
        console.log(`‚úÖ Found unused news: "${news.title}"`);
        return news;
      }
    }
    
    console.log(`‚ö†Ô∏è All news items have been used for channel ${channelId}`);
    return null;
  }

  /**
   * üñºÔ∏è OPTIMIZED: Handle image with quick validation
   */
  private async handleNewsImageOptimized(news: NewsItem): Promise<string | undefined> {
    // Use RSS image if available
    if (news.imageUrl) {
      console.log(`‚úÖ Using RSS image`);
      return news.imageUrl;
    }
    
    // Generate only if really needed
    console.log(`üé® Generating AI image`);
    
    try {
      const generatedImage = await aiImageGenerator.generateNewsImage(
        news.content.substring(0, 500), // Limit content for faster processing
        news.title,
        'en'
      );
      
      return generatedImage?.url;
    } catch (error) {
      console.error(`‚ùå Error generating image:`, error);
      return undefined;
    }
  }

  /**
   * ü§ñ OPTIMIZED: AI edit with fallback
   */
  private async aiEditNewsContentOptimized(news: NewsItem, language: 'en' | 'am' | 'sw' | 'fr' | 'ar'): Promise<string> {
    // Always try AI translation for non-English languages - don't skip for short content
    console.log(`ü§ñ AI editing news content for language: ${language}`);
    
    try {
      const openai = await getOpenAIClient();
      if (!openai) {
        console.log(`‚ùå OpenAI client not available - using template for ${language}`);
        return this.createTemplateNewsContent(news, language);
      }

      // üìä Log OpenAI call attempt
      await this.logOpenAICall('news-generation', language, news.title);

      const systemPrompts = {
        'en': `You are a football journalist. Create a complete 4-5 line summary with emojis. IMPORTANT: Always finish your sentences completely - never cut off in the middle. End with hashtags.`,
        'am': `You are an Ethiopian football journalist. TRANSLATE and REWRITE this English football news into proper, fluent Amharic language. Requirements:
1. Write ONLY in natural Amharic - no English words
2. Create a complete news story (4-5 sentences minimum)
3. CRITICAL: Always finish your sentences completely - never cut off mid-sentence
4. Include all key details from the original news
5. Use ‚öΩ emoji at the start
6. End with source and hashtags: #·ä•·åç·à≠·ä≥·àµ·ãú·äì #·àµ·çñ·à≠·âµ #·ãù·àõ·äî
7. Make it sound like native Amharic journalism`,
        'sw': `You are a football journalist writing ONLY in Swahili. Create 4-5 complete lines. IMPORTANT: Always finish your sentences completely - never cut off in the middle. End with Swahili & English hashtags.`,
        'fr': `Vous √™tes un journaliste de football √©crivant UNIQUEMENT en fran√ßais. Cr√©ez un r√©sum√© complet de 4-5 lignes. IMPORTANT: Terminez toujours vos phrases compl√®tement - ne coupez jamais au milieu. Utilisez des emojis ‚öΩ. Terminez par des hashtags fran√ßais.`,
        'ar': `ÿ£ŸÜÿ™ ÿµÿ≠ŸÅŸä ŸÉÿ±ÿ© ŸÇÿØŸÖ ÿ™ŸÉÿ™ÿ® ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÅŸÇÿ∑. ÿ£ŸÜÿ¥ÿ¶ ŸÖŸÑÿÆÿµÿßŸã ŸÉÿßŸÖŸÑÿßŸã ŸÖŸÜ 4-5 ÿ£ÿ≥ÿ∑ÿ±. ŸÖŸáŸÖ: ÿßŸÉŸÖŸÑ ÿ¨ŸÖŸÑŸÉ ÿØÿßÿ¶ŸÖÿßŸã - ŸÑÿß ÿ™ŸÇÿ∑ÿπ ÿ£ÿ®ÿØÿßŸã ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿµŸÅ. ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ±ŸÖŸàÿ≤ ‚öΩ. ÿßŸÜÿ™Ÿá ÿ®Ÿáÿßÿ¥ÿ™ÿßÿ∫ÿßÿ™ ÿπÿ±ÿ®Ÿäÿ©.`
      };

      const languageNames = {
        'en': 'English',
        'am': 'Amharic',
        'sw': 'Swahili', 
        'fr': 'fran√ßais',
        'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'
      };

      const response = await Promise.race([
        openai.chat.completions.create({
          model: "gpt-4o-mini", // Fastest model for translations
          messages: [
            { role: "system", content: systemPrompts[language] },
            { 
              role: "user", 
              content: `Create a complete news summary in ${languageNames[language]}. Translate ALL the information. Make sure to end with complete sentences:\n\nTitle: ${news.title}\nContent: ${news.content.substring(0, 800)}` 
            }
          ],
          max_tokens: 800, // Increased for complete content
          temperature: 0.7
        }),
        new Promise((_, reject) => setTimeout(() => reject(new Error('AI_TIMEOUT_30_SECONDS')), 30000))
      ]) as any;

      const aiResult = response.choices[0]?.message?.content?.trim();
      console.log(`ü§ñ AI Result for ${language}:`, aiResult ? aiResult.substring(0, 200) + '...' : 'EMPTY/NULL');
      
      if (aiResult && aiResult.length > 50) {
        console.log(`‚úÖ Using AI result for ${language}`);
        return aiResult;
      } else {
        console.log(`‚ùå AI result invalid for ${language}, using template`);
        return this.createTemplateNewsContent(news, language);
      }
    } catch (error) {
      console.log(`‚ùå AI editing failed for ${language}, error:`, error?.message || error);
      console.log(`üîç Error details:`, error);
      return this.createTemplateNewsContent(news, language);
    }
  }

  /**
   * üìù Create template-based news content for all languages
   */
  private createTemplateNewsContent(news: NewsItem, language: 'en' | 'am' | 'sw' | 'fr' | 'ar'): string {
    const shortContent = this.shortenContent(news.content, 400); // Increased from 200 to 400
    
    const templates = {
      en: `‚öΩ ${news.title}\n\n${shortContent}\n\nüîó ${news.source}\n\n#FootballNews #Breaking`,
      am: this.createAmharicNewsContent(news, shortContent),
      sw: `‚öΩ ${news.title}\n\n${shortContent}\n\nüîó Chanzo: ${news.source}\n\n#HabariMpira #FootballNews`,
      fr: this.createFrenchNewsContent(news, shortContent),
      ar: this.createArabicNewsContent(news, shortContent)
    };

    return templates[language];
  }

  /**
   * üî§ Create proper Amharic news content
   */
  private createAmharicNewsContent(news: NewsItem, shortContent: string): string {
    // Create meaningful Amharic content instead of just mixing English
    const amharicIntro = this.getAmharicNewsIntro(news.category);
    const processedContent = this.processContentForAmharic(shortContent);
    
    return `üì∞ ${amharicIntro}\n\n‚öΩ ${processedContent}\n\nüîó ·àù·äï·å≠·ç° ${news.source}\nüìÖ ${new Date().toLocaleDateString('am-ET')}\n\n#·ä•·åç·à≠·ä≥·àµ·ãú·äì #·àµ·çñ·à≠·âµ #·ãù·àõ·äî`;
  }

  /**
   * üá´üá∑ Create proper French news content
   */
  private createFrenchNewsContent(news: NewsItem, shortContent: string): string {
    const frenchIntro = this.getFrenchNewsIntro(news.category);
    const processedContent = this.processContentForFrench(shortContent);
    
    return `üì∞ ${frenchIntro}\n\n‚öΩ ${processedContent}\n\nüîó Source: ${news.source}\nüìÖ ${new Date().toLocaleDateString('fr-FR')}\n\n#FootballNews #Sport #Actualit√©Foot`;
  }

  /**
   * üá∏üá¶ Create proper Arabic news content  
   */
  private createArabicNewsContent(news: NewsItem, shortContent: string): string {
    const arabicIntro = this.getArabicNewsIntro(news.category);
    const processedContent = this.processContentForArabic(shortContent);
    
    return `üì∞ ${arabicIntro}\n\n‚öΩ ${processedContent}\n\nüîó ÿßŸÑŸÖÿµÿØÿ±: ${news.source}\nüìÖ ${new Date().toLocaleDateString('ar-SA')}\n\n#ÿ£ÿÆÿ®ÿßÿ±_ŸÉÿ±ÿ©_ÿßŸÑŸÇÿØŸÖ #ÿ±Ÿäÿßÿ∂ÿ© #ŸÉÿ±ÿ©_ÿßŸÑŸÇÿØŸÖ`;
  }

  /**
   * üåç Get Amharic intro based on news category
   */
  private getAmharicNewsIntro(category?: string): string {
    const categoryIntros = {
      'Premier League': '·ã®·çï·à™·àö·ã®·à≠ ·àä·åç ·ãú·äì',
      'Champions League': '·ã®·âª·àù·çí·ãÆ·äï·àµ ·àä·åç ·ãú·äì',
      'Transfer News': '·ã®·â∞·å´·ãã·âæ·âΩ ·ãù·ãç·ãç·à≠ ·ãú·äì',
      'World Cup': '·ã®·ãì·àà·àù ·ãã·äï·å´ ·ãú·äì',
      'La Liga': '·ã®·àã ·àä·åã ·ãú·äì',
      'Serie A': '·ã®·à¥·à™ ·ä§ ·ãú·äì',
      'Bundesliga': '·ã®·â°·äï·ã∞·àµ·àä·åã ·ãú·äì',
      'International': '·ã®·ä†·àà·àù ·ä†·âÄ·çç ·ä•·åç·à≠ ·ä≥·àµ ·ãú·äì'
    };
    
    return categoryIntros[category as keyof typeof categoryIntros] || '·ã®·ä•·åç·à≠ ·ä≥·àµ ·ãú·äì ·ä•·äì ·ãù·àõ·äî';
  }

  /**
   * üåç Get French intro based on news category
   */
  private getFrenchNewsIntro(category?: string): string {
    const categoryIntros = {
      'Premier League': 'Actualit√©s de la Premier League',
      'Champions League': 'Actualit√©s de la Ligue des Champions',
      'Transfer News': 'Actualit√©s des transferts',
      'World Cup': 'Actualit√©s de la Coupe du Monde',
      'La Liga': 'Actualit√©s de La Liga',
      'Serie A': 'Actualit√©s de la Serie A',
      'Bundesliga': 'Actualit√©s de la Bundesliga',
      'International': 'Actualit√©s du football international'
    };
    
    return categoryIntros[category as keyof typeof categoryIntros] || 'Actualit√©s et mises √† jour du football';
  }

  /**
   * üåç Get Arabic intro based on news category
   */
  private getArabicNewsIntro(category?: string): string {
    const categoryIntros = {
      'Premier League': 'ÿ£ÿÆÿ®ÿßÿ± ÿßŸÑÿØŸàÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä ÿßŸÑŸÖŸÖÿ™ÿßÿ≤',
      'Champions League': 'ÿ£ÿÆÿ®ÿßÿ± ÿØŸàÿ±Ÿä ÿ£ÿ®ÿ∑ÿßŸÑ ÿ£Ÿàÿ±Ÿàÿ®ÿß',
      'Transfer News': 'ÿ£ÿÆÿ®ÿßÿ± ÿßŸÜÿ™ŸÇÿßŸÑÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ',
      'World Cup': 'ÿ£ÿÆÿ®ÿßÿ± ŸÉÿ£ÿ≥ ÿßŸÑÿπÿßŸÑŸÖ',
      'La Liga': 'ÿ£ÿÆÿ®ÿßÿ± ÿßŸÑŸÑŸäÿ¨ÿß ÿßŸÑÿ•ÿ≥ÿ®ÿßŸÜŸäÿ©',
      'Serie A': 'ÿ£ÿÆÿ®ÿßÿ± ÿßŸÑÿØŸàÿ±Ÿä ÿßŸÑÿ•Ÿäÿ∑ÿßŸÑŸä',
      'Bundesliga': 'ÿ£ÿÆÿ®ÿßÿ± ÿßŸÑÿ®ŸàŸÜÿØÿ≥ŸÑŸäÿ¨ÿß ÿßŸÑÿ£ŸÑŸÖÿßŸÜŸäÿ©',
      'International': 'ÿ£ÿÆÿ®ÿßÿ± ŸÉÿ±ÿ© ÿßŸÑŸÇÿØŸÖ ÿßŸÑÿØŸàŸÑŸäÿ©'
    };
    
    return categoryIntros[category as keyof typeof categoryIntros] || 'ÿ£ÿÆÿ®ÿßÿ± ŸàŸÖÿ≥ÿ™ÿ¨ÿØÿßÿ™ ŸÉÿ±ÿ© ÿßŸÑŸÇÿØŸÖ';
  }

  /**
   * üìù Process content for better Amharic presentation with basic translation
   */
  private processContentForAmharic(content: string): string {
    // Basic improvement - add context for Amharic readers
    if (content.length < 50) {
      return '·ãù·à≠·ãù·à≠ ·àò·à®·åÉ ·â†·âÖ·à≠·â° ·ã≠·àò·å£·àç·ç¢ ·àà·â∞·å®·àõ·à™ ·ãù·àõ·äî ·ã≠·ä®·â∞·àâ·äï·ç¢';
    }
    
    // Clean up content and provide better Amharic context
    let cleanContent = content
      // Remove HTML tags completely
      .replace(/(<\/?)strong[^>]*>/gi, '')
      .replace(/(<\/?)p[^>]*>/gi, '\n')
      .replace(/(<\/?)div[^>]*>/gi, '\n')
      .replace(/(<\/?)span[^>]*>/gi, '')
      .replace(/(<\/?)br[^>]*>/gi, '\n')
      .replace(/(<\/?)em[^>]*>/gi, '')
      .replace(/(<\/?)b[^>]*>/gi, '')
      .replace(/(<\/?)i[^>]*>/gi, '')
      .replace(/(<\/?)a[^>]*>/gi, '')
      .replace(/(<\/?)h[1-6][^>]*>/gi, '\n')
      .replace(/<[^>]*>/g, '') // Remove any remaining HTML
      .replace(/\s{2,}/g, ' ') // Clean whitespace
      .replace(/\n{2,}/g, '\n')
      .trim();

    // Basic football terminology translation for better readability
    cleanContent = this.translateBasicFootballTerms(cleanContent);
    
    // Extract key team/player names for better context
    const teamNames = this.extractTeamNames(cleanContent);
    let contextualContent = cleanContent.substring(0, 400); // Increased from 200 to 400
    
    // Make sure we don't cut in the middle of a word
    const lastSpace = contextualContent.lastIndexOf(' ');
    if (lastSpace > 300) { // Adjusted threshold accordingly
      contextualContent = contextualContent.substring(0, lastSpace);
    }
    
    // Add proper Amharic context
    if (teamNames.length > 0) {
      return `·ã®${teamNames[0]} ·ä•·äì ·â∞·ã´·ã´·ã• ·ä≠·àà·â¶·âΩ ·ãú·äì·ç°\n\n${contextualContent}...\n\n·â∞·å®·àõ·à™ ·ãù·à≠·ãù·àÆ·âΩ ·ä®·àù·äï·å© ·ã≠·àò·àç·ä®·â±·ç¢`;
    }
    
    return `·ä®·ä†·àà·àù ·ä†·âÄ·çç ·ä•·åç·à≠ ·ä≥·àµ ·ãì·àà·àù ·ã®·ã∞·à®·à∞ ·ãà·âÖ·â≥·ãä ·ãú·äì·ç°\n\n${contextualContent}...\n\n·àà·àô·àâ ·ãù·à≠·ãù·à≠ ·àù·äï·åπ·äï ·ã≠·àò·àç·ä®·â±·ç¢`;
  }

  /**
   * üî§ Basic football terminology translation to Amharic
   */
  private translateBasicFootballTerms(content: string): string {
    const translations = {
      'football': '·ä•·åç·à≠ ·ä≥·àµ',
      'soccer': '·ä•·åç·à≠ ·ä≥·àµ', 
      'penalty': '·âÖ·å£·âµ ·àù·âµ',
      'goal': '·åé·àç',
      'match': '·å®·ãã·â≥',
      'game': '·å®·ãã·â≥',
      'team': '·â°·ãµ·äï',
      'player': '·â∞·å´·ãã·âΩ',
      'coach': '·ä†·à∞·àç·å£·äù',
      'manager': '·ä†·àµ·â∞·ã≥·ã≥·à™',
      'win': '·ãµ·àç',
      'victory': '·ãµ·àç',
      'defeat': '·àΩ·äï·çà·âµ',
      'score': '·ãç·å§·âµ',
      'league': '·àä·åç',
      'championship': '·àª·àù·çí·ãÆ·äï·à∫·çï',
      'tournament': '·ãç·ãµ·ãµ·à≠',
      'season': '·ãà·âÖ·âµ',
      'transfer': '·ãù·ãç·ãç·à≠',
      'contract': '·ãç·àç',
      'stadium': '·àµ·â≥·ã≤·ã®·àù',
      'fans': '·ã∞·åã·çä·ãé·âΩ',
      'supporters': '·ã∞·åã·çä·ãé·âΩ'
    };

    let translatedContent = content;
    
    // Apply translations while preserving original context
    Object.entries(translations).forEach(([english, amharic]) => {
      // Only translate standalone words, not parts of names
      const regex = new RegExp(`\\b${english}\\b`, 'gi');
      if (regex.test(translatedContent) && !this.isPartOfProperName(translatedContent, english)) {
        translatedContent = translatedContent.replace(regex, `${english} (${amharic})`);
      }
    });

    return translatedContent;
  }

  /**
   * Check if a word is part of a proper name (team, player, etc.)
   */
  private isPartOfProperName(content: string, word: string): boolean {
    const wordIndex = content.toLowerCase().indexOf(word.toLowerCase());
    if (wordIndex === -1) return false;
    
    // Check if the word is preceded or followed by a capital letter (indicating a proper name)
    const beforeChar = wordIndex > 0 ? content[wordIndex - 1] : ' ';
    const afterChar = wordIndex + word.length < content.length ? content[wordIndex + word.length] : ' ';
    
    return /[A-Z]/.test(beforeChar) || /[A-Z]/.test(afterChar);
  }

  /**
   * üìù Process content for better French presentation
   */
  private processContentForFrench(content: string): string {
    if (content.length < 50) {
      return 'Plus de d√©tails seront disponibles prochainement. Suivez-nous pour les derni√®res actualit√©s.';
    }
    
    const cleanContent = content
      .replace(/[<>]/g, '')
      .replace(/\s+/g, ' ')
      .trim();
    
    return cleanContent.length > 200 ? cleanContent.substring(0, 200) + '...' : cleanContent;
  }

  /**
   * üìù Process content for better Arabic presentation
   */
  private processContentForArabic(content: string): string {
    if (content.length < 50) {
      return 'ÿ≥ÿ™ÿ™ŸàŸÅÿ± ÿ™ŸÅÿßÿµŸäŸÑ ÿ£ŸÉÿ´ÿ± ŸÇÿ±Ÿäÿ®ÿßŸã. ÿ™ÿßÿ®ÿπŸàŸÜÿß ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ¢ÿÆÿ± ÿßŸÑÿ£ÿÆÿ®ÿßÿ±.';
    }
    
    const cleanContent = content
      .replace(/[<>]/g, '')
      .replace(/\s+/g, ' ')
      .trim();
    
    return cleanContent.length > 200 ? cleanContent.substring(0, 200) + '...' : cleanContent;
  }
  
  /**
   * Extract team names from content for better context
   */
  private extractTeamNames(content: string): string[] {
    const commonTeams = ['Tottenham', 'Arsenal', 'Chelsea', 'Liverpool', 'Manchester', 'City', 'United', 'Real Madrid', 'Barcelona', 'Bayern', 'PSG'];
    const foundTeams = commonTeams.filter(team => 
      content.toLowerCase().includes(team.toLowerCase())
    );
    return foundTeams.slice(0, 2); // Max 2 teams
  }

  /**
   * ‚úÇÔ∏è Shorten content efficiently
   */
  private shortenContent(content: string, maxLength: number): string {
    if (content.length <= maxLength) return content;
    
    const truncated = content.substring(0, maxLength);
    const lastSpace = truncated.lastIndexOf(' ');
    return truncated.substring(0, lastSpace) + '...';
  }

  /**
   * üìä Get used content IDs
   */
  private async getUsedContentIds(channelId: string): Promise<string[]> {
    try {
      const { data, error } = await supabase
        .from('content_uniqueness')
        .select('content_id')
        .eq('channel_id', channelId)
        .eq('content_type', 'news');

      if (error) throw error;
      return (data?.map((item: { content_id: string }) => item.content_id)) || [];

    } catch (error) {
      console.error(`‚ùå Error fetching used content:`, error);
      return [];
    }
  }

  /**
   * ‚úÖ Mark content as used (async)
   */
  private async markContentAsUsed(contentId: string, channelId: string): Promise<void> {
    try {
      await supabase
        .from('content_uniqueness')
        .insert({
          content_id: contentId,
          channel_id: channelId,
          content_type: 'news',
          used_at: new Date().toISOString(),
          variation_token: `NEWS_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
        });

    } catch (error) {
      console.error(`‚ùå Error marking content as used:`, error);
    }
  }

  /**
   * üéØ Quick method: Get latest football news (cached)
   */
  async getLatestFootballNews(language: 'en' | 'am' | 'sw' = 'en', limit: number = 5): Promise<NewsItem[]> {
    const rssNews = await this.fetchRSSNewsOptimized();
    const scoredNews = this.scoreAndRankNewsOptimized(rssNews);
    return scoredNews.slice(0, limit);
  }

  /**
   * üßπ Clear all caches
   */
  clearCaches(): void {
    RSS_CACHE.clear();
    this.scoreCache.clear();
    this.usedContentCache.clear();
    console.log('‚úÖ All caches cleared');
  }

  /**
   * üìä Log OpenAI API call for tracking usage
   */
  private async logOpenAICall(
    callType: string, 
    language: string, 
    contentTitle: string
  ): Promise<void> {
    try {
      const { error } = await supabase
        .from('openai_usage_logs')
        .insert({
          call_type: callType,
          language: language,
          content_title: contentTitle.substring(0, 200), // Limit title length
          timestamp: new Date().toISOString(),
          estimated_tokens: this.estimateTokens(contentTitle),
          status: 'initiated'
        });

      if (error) {
        console.error('Error logging OpenAI call:', error);
      } else {
        console.log(`üìä OpenAI call logged: ${callType} for ${language}`);
      }
    } catch (error) {
      console.error('Failed to log OpenAI call:', error);
    }
  }

  /**
   * üî¢ Estimate token usage for cost tracking
   */
  private estimateTokens(text: string): number {
    // Rough estimation: 1 token ‚âà 0.75 words for English, adjust for other languages
    const wordCount = text.split(' ').length;
    const tokenMultiplier = {
      'en': 0.75,
      'am': 1.2,  // Amharic typically uses more tokens
      'sw': 0.8,  // Swahili
      'fr': 0.8,  // French
      'ar': 1.0   // Arabic
    };
    
    return Math.ceil(wordCount * (tokenMultiplier['en'] || 0.75));
  }

  /**
   * üîÑ Generate fallback news content when RSS feeds fail
   */
  private async generateFallbackNewsContent(request: NewsGenerationRequest): Promise<GeneratedNews | null> {
    console.log(`üîÑ Generating AI fallback news content for ${request.language}`);
    
    try {
      const openai = await getOpenAIClient();
      if (!openai) {
        console.log('‚ùå OpenAI not available for fallback news, returning basic template');
        return this.createBasicFallbackNews(request);
      }

      const currentDate = new Date().toLocaleDateString();
      const topicPrompts = {
        'en': `Create football news content for today (${currentDate}). Write about general football topics like transfer rumors, upcoming matches, league updates, or player performances. Make it timely and engaging.`,
        'am': `·àà·ãõ·à¨ (${currentDate}) ·ã®·ä•·åç·à≠ ·ä≥·àµ ·ãú·äì ·ã≠·çç·å†·à©·ç¢ ·ã®·â∞·å´·ãã·âΩ ·ãù·ãç·ãç·à≠·ç£ ·ã®·àä·åç ·ãù·àõ·äî·ãé·âΩ·ç£ ·ãà·ã≠·àù ·ä†·àò·â∫ ·ã®·ä•·åç·à≠ ·ä≥·àµ ·à≠·ãï·à∂·âΩ ·àã·ã≠ ·â†·ä†·àõ·à≠·äõ ·ã≠·çÉ·çâ·ç¢`,
        'sw': `Unda habari za mpira wa miguu za leo (${currentDate}). Andika kuhusu mada za mpira kama vile uhamisho wa wachezaji, mechi zinazokuja, au maendeleo ya ligi.`
      };

      const systemPrompts = {
        'en': `You are a football journalist creating daily news content. Write 4-5 complete sentences about current football topics. Include emojis naturally. End with hashtags #Football #Sports #News`,
        'am': `·ä•·à≠·àµ·ãé ·ã®·ä•·åç·à≠ ·ä≥·àµ ·ãú·äì ·å∏·àê·çä ·äì·â∏·ãç·ç¢ ·àµ·àà ·ãà·âÖ·â≥·ãä ·ä•·åç·à≠ ·ä≥·àµ ·à≠·ãï·à∂·âΩ 4-5 ·àô·àâ ·ãì·à®·çç·â∞ ·äê·åà·àÆ·âΩ ·ã≠·çÉ·çâ·ç¢ ·â∞·çà·å•·àÆ·ä†·ãä ·ä¢·àû·åÇ·ãé·âΩ·äï ·ã´·ä´·âµ·â±·ç¢ ·â† #·ä•·åç·à≠·ä≥·àµ #·àµ·çñ·à≠·âµ #·ãú·äì ·ã≠·å®·à≠·à±`,
        'sw': `Wewe ni mwandishi wa habari za mpira wa miguu. Andika sentensi 4-5 kamili kuhusu mada za mpira za sasa. Jumuisha emoji kwa kawaida. Malizia na hashtags #MpiraMiguu #Michezo #Habari`
      };

      const response = await openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [
          { role: "system", content: systemPrompts[request.language] || systemPrompts['en'] },
          { role: "user", content: topicPrompts[request.language] || topicPrompts['en'] }
        ],
        max_tokens: 400,
        temperature: 0.8
      });

      const content = response.choices[0]?.message?.content?.trim();
      if (!content) {
        return this.createBasicFallbackNews(request);
      }

      // Generate an image for the fallback news
      const imageUrl = await this.generateFallbackNewsImage(request.language);

      return {
        title: this.getFallbackNewsTitle(request.language),
        content: content,
        imageUrl: imageUrl,
        sourceUrl: `https://telegrambotsport.vercel.app/news/fallback/${Date.now()}`,
        aiEditedContent: content, // Already AI generated
        metadata: {
          language: request.language,
          source: 'AI Generated Fallback',
          contentId: `fallback_${Date.now()}`,
          generatedAt: new Date().toISOString(),
          relevanceScore: 75, // Good baseline score
          telegramEnhancements: {
            protectContent: false,
            enableShareButton: true,
            enableWebApp: true,
            priority: 'normal',
            spoilerImage: false
          }
        }
      };

    } catch (error) {
      console.error('‚ùå Error generating fallback news:', error);
      return this.createBasicFallbackNews(request);
    }
  }

  /**
   * üì∞ Create basic template fallback news when AI fails
   */
  private createBasicFallbackNews(request: NewsGenerationRequest): GeneratedNews {
    const templates = {
      'en': {
        title: '‚öΩ Daily Football Updates',
        content: `üèÜ Stay updated with the latest football news and match results.\n\nüìä Check back soon for fresh updates from leagues around the world.\n\n‚öΩ Your source for reliable football content!\n\n#Football #Sports #Updates`
      },
      'am': {
        title: '‚öΩ ·ã®·ä•·åç·à≠ ·ä≥·àµ ·ãï·àà·â≥·ãä ·ãù·àõ·äî·ãé·âΩ',
        content: `üèÜ ·ä®·ãì·àà·àù ·ä†·âÄ·çç ·ä•·åç·à≠ ·ä≥·àµ ·ãì·àà·àù ·ã®·âÖ·à≠·â• ·åä·ãú ·ãú·äì·ãé·âΩ ·åã·à≠ ·ã≠·ãò·àù·äë·ç¢\n\nüìä ·ä®·â∞·àà·ã´·ã© ·àä·åé·âΩ ·ã®·àö·àò·å° ·ä†·ã≥·ã≤·àµ ·àò·à®·åÉ·ãé·âΩ ·àà·àõ·ã®·âµ ·â†·âÖ·à≠·â° ·ã≠·àò·àà·à±·ç¢\n\n‚öΩ ·àà·ä†·àµ·â∞·àõ·àõ·äù ·ä•·åç·à≠ ·ä≥·àµ ·ã≠·ãò·âµ ·ã®·ä•·à≠·àµ·ãé ·àù·äï·å≠!\n\n#·ä•·åç·à≠·ä≥·àµ #·àµ·çñ·à≠·âµ #·ãù·àõ·äî·ãé·âΩ`
      },
      'sw': {
        title: '‚öΩ Habari za Kila Siku za Mpira',
        content: `üèÜ Baki umejua habari za hivi karibuni za mpira wa miguu na matokeo ya mechi.\n\nüìä Rudi hivi karibuni kwa habari mpya kutoka ligi duniani.\n\n‚öΩ Chanzo chako cha kuaminika cha maudhui ya mpira!\n\n#MpiraMiguu #Michezo #Habari`
      }
    };

    const template = templates[request.language] || templates['en'];

    return {
      title: template.title,
      content: template.content,
      sourceUrl: `https://telegrambotsport.vercel.app/news/template/${Date.now()}`,
      metadata: {
        language: request.language,
        source: 'Template Fallback',
        contentId: `template_${Date.now()}`,
        generatedAt: new Date().toISOString(),
        relevanceScore: 60,
        telegramEnhancements: {
          protectContent: false,
          enableShareButton: true,
          enableWebApp: true,
          priority: 'normal'
        }
      }
    };
  }

  /**
   * üñºÔ∏è Generate fallback news image
   */
  private async generateFallbackNewsImage(language: string): Promise<string | undefined> {
    try {
      const prompts = {
        'en': 'Football stadium atmosphere with fans cheering, modern sports photography style',
        'am': 'Ethiopian football fans celebrating in stadium, vibrant atmosphere, sports photography',
        'sw': 'African football stadium with passionate fans, colorful banners, sports photography'
      };

      return await aiImageGenerator.generateImage({
        type: 'news',
        prompt: prompts[language] || prompts['en'],
        language: language as 'en' | 'am' | 'sw'
      });
    } catch (error) {
      console.error('‚ùå Error generating fallback news image:', error);
      return undefined;
    }
  }

  /**
   * üì∞ Get fallback news title
   */
  private getFallbackNewsTitle(language: string): string {
    const titles = {
      'en': '‚öΩ Football News Update',
      'am': '‚öΩ ·ã®·ä•·åç·à≠ ·ä≥·àµ ·ãú·äì ·ãù·àõ·äî', 
      'sw': '‚öΩ Habari za Mpira'
    };
    return titles[language] || titles['en'];
  }
}

// Export singleton instance
export const newsContentGenerator = new OptimizedNewsContentGenerator();